#! /usr/bin/env bash

#-------------------------------------------------------------------------#
#                                  crypt                                  #
#                                                                         #
# Author: Nic H.                                                          #
# Date: 2016-Jan-29                                                       #
#                                                                         #
# Encrypt and decrypt files using openssl.                                #
#                                                                         #
# Usage:                                                                  #
#     crypt [-c CIPHER] <file>                                            #
# encrypts or decrypts <file> with cipher CIPHER                          #
#-------------------------------------------------------------------------#

set -u
set -e

function usage(){
    grep "^#.*#$" $0
}

CIPHER="aes-256-cbc"

while getopts "hc:" opt; do
    case $opt in
        h)
            usage
            exit 0
            ;;
	c)
            CIPHER="$OPTARG"
            ;;
        \?)
            exit 1
            ;;
    esac
done
shift $(($OPTIND -1))

if [ $# != 1 ] || [ ! -f $1 ] ; then
    echo "Cannot find file for encryption/decryption: $@" >&2
    exit 1
fi

OUT=$1.$CIPHER.enc
MODE=""
MODE_NAME="encrypting"

if [[ $1 =~ .*$CIPHER\.enc$ ]] ; then
    OUT=${1%\.${CIPHER}.enc}
    MODE="-d"
    MODE_NAME="decrypting"
fi

if [ -f $OUT ] ; then
    echo "Output file already exists: $OUT" >&2
    exit 1;
fi

echo "$MODE_NAME $1 -> $OUT"
openssl enc -$CIPHER $MODE -a -in $1 -out $OUT
